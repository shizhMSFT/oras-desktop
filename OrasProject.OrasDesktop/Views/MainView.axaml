<UserControl
  x:Class="OrasProject.OrasDesktop.Views.MainView"
  xmlns="https://github.com/avaloniaui"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:vm="clr-namespace:OrasProject.OrasDesktop.ViewModels"
  xmlns:svc="clr-namespace:OrasProject.OrasDesktop.Services"
  d:DesignHeight="600"
  d:DesignWidth="1000"
  x:DataType="vm:MainViewModel"
  mc:Ignorable="d">
  <Design.DataContext>
    <!--
      This only sets the DataContext for the previewer in an IDE,
      to set the actual DataContext for runtime, set the DataContext property in code (look at App.axaml.cs)
    -->
    <vm:MainViewModel />
  </Design.DataContext>

  <Grid RowDefinitions="Auto,*,Auto,Auto">
    <!--  Header with connection panel  -->
    <Grid
      Grid.Row="0"
      Margin="10"
      ColumnDefinitions="Auto,*">
      <StackPanel
        Grid.Column="0"
        Orientation="Horizontal"
        Spacing="5">
        <TextBlock VerticalAlignment="Center" Text="Registry:" />
        <TextBox
          Width="250"
          Text="{Binding RegistryUrl}"
          Watermark="Enter registry (e.g., mcr.microsoft.com)" />
        <Button Name="ConnectButton" Command="{Binding ConnectCommand}" Content="Connect" ToolTip.Tip="Click to connect anonymously, or hold Shift to force login" />
      </StackPanel>
    </Grid>

    <!--  Main content panel  -->
    <Grid Grid.Row="1" ColumnDefinitions="250,250,*">
      <!--  Repository tree view panel  -->
      <Grid
        Grid.Column="0"
        Margin="10,0,5,10"
        RowDefinitions="Auto,Auto,*">
        <TextBlock
          Grid.Row="0"
          Margin="0,0,0,2"
          FontWeight="Bold"
          Text="Repositories" />
        <TextBox
          Grid.Row="1"
          Watermark="Filter repositories..."
          Text="{Binding RepositoryFilterText}" />
        <TreeView
          Grid.Row="2"
          ItemsSource="{Binding FilteredRepositories}"
          SelectedItem="{Binding SelectedRepository}">
          <TreeView.ItemTemplate>
            <TreeDataTemplate ItemsSource="{Binding Children}">
              <TextBlock Text="{Binding Name}" />
            </TreeDataTemplate>
          </TreeView.ItemTemplate>
        </TreeView>
      </Grid>

      <!--  Tags panel  -->
      <Grid
        Grid.Column="1"
        Margin="5,0,5,10"
        RowDefinitions="Auto,Auto,*">
        <TextBlock
          Grid.Row="0"
          Margin="0,0,0,5"
          FontWeight="Bold"
          Text="Tags" />
        <StackPanel
          Grid.Row="1"
          Margin="0,0,0,5"
          Orientation="Horizontal"
          Spacing="5">
          <Button Command="{Binding RefreshTagsCommand}" Content="Refresh" />
        </StackPanel>
        <ListBox
          Grid.Row="2"
          ItemsSource="{Binding Tags}"
          SelectedItem="{Binding SelectedTag}">
          <ListBox.ItemTemplate>
            <DataTemplate>
              <TextBlock Text="{Binding Name}" />
            </DataTemplate>
          </ListBox.ItemTemplate>
        </ListBox>
      </Grid>

      <!--  Artifact details panel  -->
      <Grid
        Grid.Column="2"
        Margin="5,0,10,10"
        RowDefinitions="Auto,Auto,Auto,Auto,Auto,*">
        <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="5" Margin="0,0,0,5">
          <TextBlock
            FontWeight="Bold"
            Text="Artifact Details" />
          <TextBlock 
            Text="{Binding CurrentManifest.Digest}"
            FontFamily="Consolas"
            FontSize="12"
            Foreground="Gray"
            IsVisible="{Binding CurrentManifest.Digest, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
            VerticalAlignment="Center" />
        </StackPanel>

        <!-- Artifact Size Summary when not showing platform sizes -->
        <TextBlock
          Grid.Row="2"
          Margin="0,0,0,5"
          FontWeight="Normal"
          FontStyle="Italic"
          Text="{Binding ArtifactSizeSummary}"
          IsVisible="{Binding !HasPlatformSizes}" />

        <!-- Platform Image Sizes -->
        <Grid Grid.Row="3" Margin="0,0,0,5" IsVisible="{Binding HasPlatformSizes}">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>
          <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="5" Margin="0,0,0,5">
            <TextBlock FontWeight="Bold" Text="Platform Image Sizes" VerticalAlignment="Center"/>
            <TextBlock Text="â€”" VerticalAlignment="Center" Foreground="Gray"/>
            <TextBlock Text="{Binding ArtifactSizeSummary}" VerticalAlignment="Center" FontStyle="Italic" Foreground="Gray"/>
          </StackPanel>
          <Border
            Grid.Row="1"
            BorderBrush="LightGray"
            BorderThickness="1"
            CornerRadius="3"
            MinHeight="60"
            Background="#F8F8F8">
            <ScrollViewer MaxHeight="150" VerticalScrollBarVisibility="Auto" Margin="0">
              <ItemsControl ItemsSource="{Binding PlatformImageSizes}" Margin="4">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Margin="0,2" Padding="6,4" BorderBrush="LightGray" BorderThickness="0,0,0,1">
                      <Grid ColumnDefinitions="Auto,*,Auto">
                        <TextBlock Grid.Column="0" Text="{Binding Platform}" FontFamily="Consolas" 
                                  FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <ProgressBar Grid.Column="1" Margin="12,0" Height="8" Minimum="0" Maximum="100" 
                                    Value="{Binding RelativePercentage}" Background="Transparent" Foreground="#99ccff"/>
                        <TextBlock Grid.Column="2" Text="{Binding HumanReadableSize}" 
                                  Foreground="#505050" VerticalAlignment="Center"/>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </Border>
        </Grid>

        <StackPanel
          Grid.Row="4"
          Margin="0,0,0,5"
          Orientation="Horizontal"
          Spacing="5">
          <Button
            Command="{Binding DeleteManifestCommand}"
            Content="Delete"
            IsEnabled="{Binding CanModifySelectedTag}" />
          <Button
            Command="{Binding CopyManifestCommand}"
            Content="Copy"
            IsEnabled="{Binding CanModifySelectedTag}" />
        </StackPanel>
        
        <!-- TabControl for Manifest and Referrers -->
        <TabControl Grid.Row="5">
          <TabItem Header="Manifest">
            <Border
              BorderBrush="LightGray"
              BorderThickness="1">
              <ScrollViewer
                HorizontalScrollBarVisibility="Auto"
                VerticalScrollBarVisibility="Auto">
                <ContentControl
                  Content="{Binding ManifestViewer}"
                  Background="Transparent"
                  FontFamily="Consolas" />
              </ScrollViewer>
            </Border>
          </TabItem>
          <TabItem Header="Referrers">
            <Border
              BorderBrush="LightGray"
              BorderThickness="1"
              MinHeight="120">
              <ScrollViewer VerticalScrollBarVisibility="Auto">
                <TreeView ItemsSource="{Binding Referrers}">
                  <TreeView.ItemTemplate>
                    <TreeDataTemplate ItemsSource="{Binding Children}">
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="{Binding Display}" FontFamily="Consolas" />
                      </StackPanel>
                    </TreeDataTemplate>
                  </TreeView.ItemTemplate>
                </TreeView>
              </ScrollViewer>
            </Border>
          </TabItem>
        </TabControl>
      </Grid>
    </Grid>

    <!--  Reference panel with search and copy functionality  -->
    <Border
      Grid.Row="2"
      Margin="10,0,10,5"
      BorderBrush="#E0E0E0"
      BorderThickness="1"
      CornerRadius="4"
      Background="#F5F5F5">
      <Grid 
        Margin="8,6"
        ColumnDefinitions="Auto,*,Auto,Auto">
        <StackPanel 
          Grid.Column="0" 
          Orientation="Horizontal" 
          Spacing="4"
          VerticalAlignment="Center">
          <!-- Search/Reference icon -->
          <Viewbox Width="14" Height="14" VerticalAlignment="Center">
            <Path
              Data="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"
              Fill="#666666" />
          </Viewbox>
          <TextBlock
            FontWeight="SemiBold"
            Foreground="#666666"
            VerticalAlignment="Center"
            Text="Reference:" />
        </StackPanel>
        
        <!-- Reference TextBox with improved styling -->
        <TextBox
          Grid.Column="1"
          Margin="8,0,0,0"
          Padding="8,8"
          VerticalAlignment="Center"
          Background="White"
          BorderBrush="#DDDDDD"
          BorderThickness="1"
          CornerRadius="3"
          FontFamily="Consolas"
          FontSize="13"
          Watermark="Enter registry/repository:tag or @digest..."
          Text="{Binding SelectedTagReference}"
          KeyDown="ReferenceTextBox_KeyDown"
          Name="ReferenceTextBox" />
        
        <!-- Search Button -->
        <Button
          Grid.Column="2"
          Width="32"
          Height="28"
          Margin="6,0,4,0"
          Padding="0"
          Command="{Binding LoadManifestByReferenceCommand}"
          ToolTip.Tip="Search for this reference"
          VerticalAlignment="Center">
          <Path
            Width="14"
            Height="14"
            Data="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"
            Fill="{DynamicResource ButtonForeground}"
            Stretch="Uniform" />
        </Button>
        
        <!-- Copy Button -->
        <Button
          Grid.Column="3"
          Width="32"
          Height="28"
          Padding="0"
          Command="{Binding CopyReferenceCommand}"
          ToolTip.Tip="Copy reference to clipboard"
          VerticalAlignment="Center">
          <Path
            Width="14"
            Height="14"
            Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"
            Fill="{DynamicResource ButtonForeground}"
            Stretch="Uniform" />
        </Button>
      </Grid>
    </Border>

    <!--  Status bar  -->
    <Grid
      Grid.Row="3"
      Height="30"
      Background="#f0f0f0"
      ColumnDefinitions="*,Auto">
      <TextBlock
        Grid.Column="0"
        Margin="10,0,0,0"
        VerticalAlignment="Center"
        Text="{Binding StatusMessage}" />
      <!-- Combined progress bar that handles both modes -->
      <ProgressBar
        Grid.Column="1"
        Width="100"
        Height="15"
        Margin="0,0,10,0"
        Value="{Binding ProgressValue}"
        Maximum="100"
        IsIndeterminate="{Binding IsProgressIndeterminate}" />
    </Grid>
  </Grid>
</UserControl>
